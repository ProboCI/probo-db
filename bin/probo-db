#! /usr/bin/env node
'use strict';

const util = require('util');
const path = require('path');
const Loader = require('yaml-config-loader');
const yargs = require('yargs');
const loader = new Loader();

const knexConfig = require('../knexfile');
const probodb = require('..');
const Server = probodb.lib.Server;
const Db = probodb.lib.Db;
let knexOverride = {};

process.env.NODE_ENV = process.env.NODE_ENV || 'production';

const argv = yargs
  .describe('config', 'A YAML config file or directory of yaml files to load, can be invoked multiple times and later files will override earlier.')
  .alias('config', 'c')
  .alias('knexfile', 'k')
  .argv;

loader.on('error', function(error) {
  if (error.name === 'YAMLException') {
    console.error(util.print('Error parsing YAML file `', error.filePath, '`:', error.reason));
    console.log(error);
  }
});

loader.add(path.resolve(path.join(__dirname, '..', 'defaults.yaml')));

if (argv.config) {
  loader.add(path.resolve(argv.config));
}

if (argv.knexfile) {
  knexOverride = require(argv.knexfile);
  Object.assign(knexConfig, knexOverride);
}

loader.addAndNormalizeObject({knex: knexConfig});

loader.load(function(error, config) {
  const knex = require('knex')(config.knex[process.env.NODE_ENV]);
  const db = new Db(knex);
  const dbPluginClasses = require(config.pluginDirectory).dbPlugins;
  const dbPlugins = dbPluginClasses.map(function(dbPluginClass) {
    return new dbPluginClass(knex);
  });
  const server = new Server({config, db, dbPlugins});
  server.start();
});
